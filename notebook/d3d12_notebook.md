# DirectX12入门笔记

## Directx12设备
在DirectX12运行过程中，最重要的莫过于ID3D12Device。一个D3D12设备通过DXGIFactory创建，创建时可选传入一个IDXGIAdapter，在大多数情况下指的是一块显卡。

## 命令
DirectX12基于命令驱动，一个应用可以有许多个命令队列，命令队列中存储着数个命令列表。每一个命令列表都对应一个命令分配器，由它为命令列表分配内存。在写入命令列表前，需要先把命令分配器重置，然后再重置命令列表。在写完命令后，把命令列表打包到命令队列中，让命令队列开始执行命令。命令的执行是在GPU中进行的，因此，一旦涉及到命令列表的执行，需要时刻警惕GPU与CPU是否同步。

## GPU资源
在渲染过程中的一切数据几乎都存储在显存里。显存与内存的交互通过PCIE。要想创建一块GPU资源，就需要调用CreateCommittedResource函数。GPU资源存储在堆中，堆具有许多类型，最常用的是默认堆与上传堆。上传堆在内存，GPU读取时通过PCIE读取；默认堆在显存，需要显式地从上传堆复制过去，GPU访问延迟极低。

## 着色器
着色器是GPU层面的程序。GPU有非常多流式处理器，这些处理器运行着色器进行计算。
### 顶点着色器
在DirectX中，图形的基础图元是三角形。三角形由三个顶点构造。在构造顶点时，我们选取一个局部坐标系定义它，然后我们通过线性变换将顶点们映射到世界坐标系。顶点着色器就是负责将这些顶点做线性变换计算的。我们在CPU端将顶点数据传输到显存，然后构造一个世界矩阵，由GPU为每个顶点执行线性变换。执行线性变换的代码就在顶点着色器里。在顶点着色器计算完成后，它会输出信息到下一阶段着色器中，一般下一阶段就是片段着色器，或者像素着色器。
### 片段着色器
GPU会根据坐标进行线性插值，在顶点构造的三角形内构造出数个片段，这些片段将会由片段着色器上色，最终合成出片段的颜色。光照、纹理等复杂的效果都在片段着色器中计算。

## 光栅化
一旦片段着色器执行完毕，这些片段都会被光栅化为具体的像素进行呈现。

## 流水管线PSO
PSO是DirectX12、Vulkan等现代图形API区别于传统图形API的重要部分。在OpenGL等传统API中，主要依赖状态机自动控制渲染过程，势必造成许多性能损失。DirectX12将流水管线暴露给用户，使得用户可以完全控制渲染过程，极致优化渲染效率。PSO定义了渲染过程中所需要的一切状态，包括着色器代码、光栅化、深度或模板测试等。创建PSO是一个耗时的操作。现代的游戏通过提前构造出可能的PSO组合，预编译PSO然后存储到硬盘上以优化性能，在使用时只需要加载这些预编译的PSO即可，大大优化了渲染效率。